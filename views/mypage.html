{% extends 'layout.html' %}

{% block content %}

 {% if user and user.localId %}
    <input id="my-nick" type="hidden" value="{{user.nick}}">
    <div>
        <input type="text" name="userFollow" id="followNick" placeholder="닉네임 입력"> {# req.query.hashtag #}
        <button id="follow">팔로우</button>
    </div>

    <div>
        <form id="nick-form" action="/auth/modifyUser" method="post"> 
            <input id="nick" name="usernick" maxlength="15" placeholder="변경할 닉네임"></input> 
            <button id="twit-btn" type="submit" class="btn">닉네임 변경</button> {# type이 submit이면 form의 action의 주소가 실행됨 #}
        </form>
    </div>

{% endif %}

    <a id="follow" href="/mypage/follow" class="btn">팔로잉/팔로워</a>
    
    <div class="food-form"> 내가 선택한 음식들
        <div class="koreanfood-form"> [ 한식 ]
           {# 0은 categorynumber가 1인거 하기위해서 #}
            {% if foodSelectlist and (user.id).toString() in foodSelectlist[0].userlike %}
                {% if user.id == foodSelectlist.user %}
                    <a id="form-modify" href="/form/update/1" class="btn">수정하기</a>
                    <button id="form-remove" onClick='removeSelect({{foodSelectlist.user}}, {{user.id}}, 1)' class="btn">삭제하기</button>
                {% endif %}
            {% else %}
                <a id="form" href="/form/1" class="btn">선택하기</a>
            {% endif %}
            {% for foodSelect in foodSelectlist %}
                {% if foodSelect and foodSelect.id and foodSelect.categorynumber == 1 %}
                    <div>
                        {{loop.index}}  
                        {{foodSelect.name}}
                        {% if (user.id).toString() in foodSelect.userlike %}
                            {% if foodSelect.userlike[user.id] == 1 %}
                                (호)
                            {% else %}
                                (불호)
                            {% endif %}
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <div class="chinesefood-form"> [ 중식 ] 
            {% if foodSelectlist and (user.id).toString() in foodSelectlist[20].userlike %}
                {% if user.id == foodSelectlist.user %}
                    <a id="form-modify" href="/form/update/2" class="btn">수정하기</a>
                    <button id="form-remove" onClick='removeSelect({{foodSelectlist.user}}, {{user.id}}, 2)' class="btn">삭제하기</button>               
                {% endif %}
            {% else %}
                <a id="form" href="/form/2" class="btn">선택하기</a>
            {% endif %}

            {% for foodSelect in foodSelectlist %}
                {% if foodSelect and foodSelect.id and foodSelect.categorynumber == 2 %}
                    <div>
                        {{loop.index}}  
                        {{foodSelect.name}}
                        {% if (user.id).toString() in foodSelect.userlike %}
                            {% if foodSelect.userlike[user.id] == 1 %}
                                (호)
                            {% else %}
                                (불호)
                            {% endif %}
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <div class="japanesefood-form"> [ 일식 ] 
            {% if foodSelectlist and (user.id).toString() in foodSelectlist[28].userlike %}
                {% if user.id == foodSelectlist.user %}
                    <a id="form-modify" href="/form/update/3" class="btn">수정하기</a>
                    <button id="form-remove" onClick='removeSelect({{foodSelectlist.user}}, {{user.id}}, 3)' class="btn">삭제하기</button>               
                {% endif %}
            {% else %}
                <a id="form" href="/form/3" class="btn">선택하기</a>
            {% endif %}

            {% for foodSelect in foodSelectlist %}
                {% if foodSelect and foodSelect.id and foodSelect.categorynumber == 3 %}
                    <div>
                        {{loop.index}}  
                        {{foodSelect.name}}
                        {% if (user.id).toString() in foodSelect.userlike %}
                            {% if foodSelect.userlike[user.id] == 1 %}
                                (호)
                            {% else %}
                                (불호)
                            {% endif %}
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <div class="westernfood-form"> [ 양식 ] 
            {% if foodSelectlist and (user.id).toString() in foodSelectlist[37].userlike %}
                {% if user.id == foodSelectlist.user %}
                    <a id="form-modify" href="/form/update/4" class="btn">수정하기</a>
                    <button id="form-remove" onClick='removeSelect({{foodSelectlist.user}}, {{user.id}}, 4)' class="btn">삭제하기</button>               
                {% endif %}
            {% else %}
                <a id="form" href="/form/4" class="btn">선택하기</a>
            {% endif %}

            {% for foodSelect in foodSelectlist %}
                {% if foodSelect and foodSelect.id and foodSelect.categorynumber == 4 %}
                    <div>
                        {{loop.index}}  
                        {{foodSelect.name}}
                        {% if (user.id).toString() in foodSelect.userlike %}
                            {% if foodSelect.userlike[user.id] == 1 %}
                                (호)
                            {% else %}
                                (불호)
                            {% endif %}
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <div class="likedislike-form"> [ 호불호 ] 
            {% if foodSelectlist and (user.id).toString() in foodSelectlist[46].userlike %}
                {% if user.id == foodSelectlist.user %}
                    <a id="form-modify" href="/form/update/5" class="btn">수정하기</a>
                    <button id="form-remove" onClick='removeSelect({{foodSelectlist.user}}, {{user.id}}, 5)' class="btn">삭제하기</button>               
                {% endif %}
            {% else %}
                <a id="form" href="/form/5" class="btn">선택하기</a>
            {% endif %}

            {% for foodSelect in foodSelectlist %}
                {% if foodSelect and foodSelect.id and foodSelect.categorynumber == 5 %}
                    <div>
                        {{loop.index}}  
                        {{foodSelect.name}}
                        {% if (user.id).toString() in foodSelect.userlike %}
                            {% if foodSelect.userlike[user.id] == 1 %}
                                (호)
                            {% else %}
                                (불호)
                            {% endif %}
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <div class="follower-list">
        <h2>팔로잉 목록</h2>
        {% if user.Followings %} 
            {% for following in user.Followings %} 
                <div>
                    {{following.nick}}
                    <div class="following-percent">
                        {% for percent in percentlist %}
                            {% if percent.id==following.id %}
                                {% if ('1' in percent.categorypercent) %}
                                    {{ percent.categorypercent['1'] }}%
                                {% endif %}
                                {% if ('2' in percent.categorypercent) %}
                                    {{ percent.categorypercent['2'] }}%
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        <button id="show">더보기</button>
                    </div>
                    {% for foodSelect in foodSelectlist %} {# 푸드 각각을 나누어줌 #}
                        {% if foodSelect and foodSelect.id and foodSelect.categorynumber == 1 %} {# 카테고리 나눔#}
                        <div>
                            {{foodSelect.name}} 
                            {# {{following.id}} user가 following 하는 사람 #}
                            {% if following.id in foodSelect.userlike %}
                                {% if foodSelect.userlike[following.id]==1 %}
                                    (호)
                                {% else %}
                                    (불호)       
                                {% endif %}
                            {% endif %}
                        </div>
                        {% endif %}
                        {% if foodSelect and foodSelect.id and foodSelect.categorynumber == 2 %} {# 카테고리 나눔#}
                        <div>
                            {{foodSelect.name}} 
                            {# {{following.id}} user가 following 하는 사람 #}
                            {% if following.id in foodSelect.userlike %}
                                {% if foodSelect.userlike[following.id]==1 %}
                                    (호)
                                {% else %}
                                    (불호)
                                {% endif %}
                            {% endif %}
                        </div>
                        {% endif %}
                        {% if foodSelect and foodSelect.id and foodSelect.categorynumber == 3 %} {# 카테고리 나눔#}
                        <div>
                            {{foodSelect.name}} 
                            {# {{following.id}} user가 following 하는 사람 #}
                            {% if following.id in foodSelect.userlike %}
                                {% if foodSelect.userlike[following.id]==1 %}
                                    (호)
                                {% else %}
                                    (불호)
                                {% endif %}
                            {% endif %}
                        </div>
                        {% endif %}
                        {% if foodSelect and foodSelect.id and foodSelect.categorynumber == 4 %} {# 카테고리 나눔#}
                        <div>
                            {{foodSelect.name}} 
                            {# {{following.id}} user가 following 하는 사람 #}
                            {% if following.id in foodSelect.userlike %}
                                {% if foodSelect.userlike[following.id]==1 %}
                                    (호)
                                {% else %}
                                    (불호)
                                {% endif %}
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% endfor %}
        {% endif %}
    </div>
{% endblock %}


{% block script %}
    <script>

        async function removeSelect(selectUserid, userid, category){
           await axios.post(`/form/remove`,{
               selectUserid,
               userid,
               category,
           }).then((res)=>{
               if(res.data.status==="true"){
                   location.reload();
               }
               else if(res.data.status==="not equal user"){
                   alert(selectUserid+"님의 정보가 아닙니다!");
               }
           })
       }

{# document.querySelector('#follow').addEventListener('click', function(e){

}
        async function modifySelect(selectUserid, userid, category){
           await axios.post(`/form/modify`,{
               selectUserid,
               userid,
               category,
           }).then((res)=>{
               if(res.data.status==="true"){
                   location.reload();
               }
               else if(res.data.status==="not equal user"){
                   alert(selectUserid+"님의 정보가 아닙니다!");
               }
           })
       } #}

       document.querySelector('#follow').addEventListener('click', function(e) {
                    const myId = document.querySelector('#my-nick'); // myId는 현재 로그인한 사용자, layout.html에 있는 <input id="my-id" type="hidden" value="{{user.id}}">
                    
                    if(myId){
                        const userNick = document.querySelector('#followNick').value; // parentNode는 "class=twit"임. 즉, 바로 위의 div를 뜻함
                        if(userNick !== myId.value){
                            if(confirm(userNick + '님을 팔로우하시겠습니까?')){
                                axios.post(`user/follow/${userNick}`) // 입력된 닉네임
                            .then(() =>{
                                location.reload();
                            })
                            .catch((err)=>{
                                console.error(err);
                            }); 
                        }
                    }
                    else{
                        alert('본인은 팔로우 할 수 없습니다!');
                    }
                }
        });
        

    </script>
{% endblock %}    